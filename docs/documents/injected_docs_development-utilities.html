<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>injected/docs/development-utilities | @duckduckgo/content-scope-scripts</title><meta name="description" content="Documentation for @duckduckgo/content-scope-scripts"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">@duckduckgo/content-scope-scripts</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="" aria-current="page">injected/docs/development-utilities</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="development-utilities" class="tsd-anchor-link">Development Utilities<a href="#development-utilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1>
<h2 id="overview" class="tsd-anchor-link">Overview<a href="#overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>To handle the difference in scope injection we expose multiple utilities which behave differently per browser in <code>src/utils.js</code> and <code>ContentFeature</code> base class. For Firefox the code exposed handles <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Sharing_objects_with_page_scripts">xrays correctly</a> without needing the features to be authored differently.</p>
<h2 id="development-setup" class="tsd-anchor-link">Development Setup<a href="#development-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="repository-access" class="tsd-anchor-link">Repository Access<a href="#repository-access" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ol>
<li><strong>Clone the repository</strong>: <code>https://github.com/duckduckgo/content-scope-scripts</code></li>
<li><strong>Request write-access</strong> (for contributors): Submit a request via <a href="https://app.asana.com/1/137249556945/project/908478224964033/task/1209367367171662?focus=true">Internal Support README</a> asking for <code>https://github.com/orgs/duckduckgo/teams/core</code> group access</li>
</ol>
<h3 id="local-development-setup" class="tsd-anchor-link">Local Development Setup<a href="#local-development-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p><strong>Important</strong>: Before cloning the repo on Windows, to avoid major headaches, make sure you clone it with unix-style line endings:</p>
<pre><code class="shell"><span class="hl-3">git</span><span class="hl-2"> </span><span class="hl-7">clone</span><span class="hl-2"> </span><span class="hl-1">--config</span><span class="hl-2"> </span><span class="hl-7">core.autocrlf=</span><span class="hl-1">false</span><span class="hl-2"> </span><span class="hl-7">https://github.com/duckduckgo/content-scope-scripts</span>
</code><button type="button">Copy</button></pre>

<p>The Content Scope Scripts repo includes the build artifacts, which need to be generated as part of your commit.</p>
<h3 id="initial-setup" class="tsd-anchor-link">Initial Setup<a href="#initial-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Inside the repo, run:</p>
<pre><code class="shell"><span class="hl-3">npm</span><span class="hl-2"> </span><span class="hl-7">ci</span><span class="hl-2">  </span><span class="hl-0"># Preferred over &#39;npm install&#39; for accurate lockfile updates</span>
</code><button type="button">Copy</button></pre>

<p>Ensure you have a version of node that matches what's in the <code>.nvmrc</code> file.</p>
<p>Now, to ensure everything's setup, try a full build:</p>
<pre><code class="shell"><span class="hl-3">npm</span><span class="hl-2"> </span><span class="hl-7">run</span><span class="hl-2"> </span><span class="hl-7">build</span>
</code><button type="button">Copy</button></pre>

<p>This will place built files into the top-level <code>build</code> folder. If this command ran successfully, you can continue with development.</p>
<h3 id="windows-development" class="tsd-anchor-link">Windows Development<a href="#windows-development" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>The tools should work on Windows, but if you have problems you <em>may</em> wish to try using WSL.</p>
<p><strong>Optional:</strong>: Use Windows Subsystem for Linux - <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL Installation Guide</a></p>
<p>Once you have WSL running, make sure you have node and make installed:</p>
<pre><code class="shell"><span class="hl-3">sudo</span><span class="hl-2"> </span><span class="hl-7">apt</span><span class="hl-2"> </span><span class="hl-7">update</span><br/><span class="hl-3">sudo</span><span class="hl-2"> </span><span class="hl-7">apt</span><span class="hl-2"> </span><span class="hl-7">install</span><span class="hl-2"> </span><span class="hl-7">make</span>
</code><button type="button">Copy</button></pre>

<p>For Node.js installation: <a href="https://computingforgeeks.com/how-to-install-node-js-on-ubuntu-debian/">How to Install Node.js on Ubuntu/Debian</a></p>
<p>Once node is installed, navigate to the repo path (e.g., <code>/mnt/c/dev/git/content-scope-scripts</code>) and:</p>
<pre><code class="shell"><span class="hl-3">npm</span><span class="hl-2"> </span><span class="hl-7">install</span><span class="hl-2">    </span><span class="hl-0"># Install packages</span><br/><span class="hl-3">npm</span><span class="hl-2"> </span><span class="hl-7">run</span><span class="hl-2"> </span><span class="hl-7">build</span><span class="hl-2">  </span><span class="hl-0"># Build JS artifacts</span>
</code><button type="button">Copy</button></pre>

<p>After this, you can commit the generated files from your Windows environment through the usual git tools.</p>
<h3 id="docker-alternative" class="tsd-anchor-link">Docker Alternative<a href="#docker-alternative" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>If you don't want to install npm on your machine, you can use Docker instead:</p>
<pre><code class="shell"><span class="hl-3">docker</span><span class="hl-2"> </span><span class="hl-7">run</span><span class="hl-2"> </span><span class="hl-1">-it</span><span class="hl-2"> </span><span class="hl-1">--rm</span><span class="hl-2"> </span><span class="hl-1">-v</span><span class="hl-2"> </span><span class="hl-7">&quot;&lt;repo root&gt;/submodules/content-scope-scripts:/content-scope-scripts&quot;</span><span class="hl-2"> </span><span class="hl-7">node:latest</span><span class="hl-2"> </span><span class="hl-7">/bin/bash</span><br/><br/><span class="hl-3">root@</span><span class="hl-2">&lt;id&gt;:/# cd /content-scope-scripts</span><br/><span class="hl-3">root@</span><span class="hl-2">&lt;id&gt;:/content-scope-scripts# npm install</span><br/><span class="hl-3">root@</span><span class="hl-2">&lt;id&gt;:/content-scope-scripts# npm run build</span>
</code><button type="button">Copy</button></pre>

<h2 id="contentfeature-utilities" class="tsd-anchor-link">ContentFeature Utilities<a href="#contentfeature-utilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="_" class="tsd-anchor-link"><code>ContentFeature.defineProperty(object, propertyName, descriptor)</code><a href="#_" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Behaves the same as <code>Object.defineProperty(object, propertyName, descriptor)</code>. The difference is for Firefox we export the relevant functions so it can go across the xray. Use this method if <code>Object.getOwnPropertyDescriptors(object).propertyName</code> should exist in the supporting browser.</p>
<h3 id="_-1" class="tsd-anchor-link"><code>ContentFeature.wrapProperty(object, propertyName, descriptor)</code><a href="#_-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>A simple wrapper around <code>defineProperty()</code> that ignores non-existing properties and retains unspecified descriptor keys.</p>
<p><strong>Example usage:</strong></p>
<pre><code class="javascript"><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">wrapProperty</span><span class="hl-2">(</span><span class="hl-7">&#39;Navigator.prototype.userAgent&#39;</span><span class="hl-2">, { </span><span class="hl-3">get</span><span class="hl-4">:</span><span class="hl-2"> () </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-7">&#39;fakeUA&#39;</span><span class="hl-2"> });</span>
</code><button type="button">Copy</button></pre>

<h3 id="_-2" class="tsd-anchor-link"><code>ContentFeature.wrapMethod(object, propertyName, wrapperFn)</code><a href="#_-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Overrides a native method. <code>wrapperFn()</code> will be called in place of the original method. The original method will be passed as the first argument.</p>
<p><strong>Example usage:</strong></p>
<pre><code class="javascript"><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">wrapMethod</span><span class="hl-2">(</span><span class="hl-8">Permissions</span><span class="hl-2">.</span><span class="hl-4">prototype</span><span class="hl-2">, </span><span class="hl-7">&#39;query&#39;</span><span class="hl-2">, </span><span class="hl-1">async</span><span class="hl-2"> </span><span class="hl-1">function</span><span class="hl-2"> (</span><span class="hl-4">originalFn</span><span class="hl-2">, </span><span class="hl-4">queryObject</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">queryObject</span><span class="hl-2">.</span><span class="hl-4">name</span><span class="hl-2"> === </span><span class="hl-7">&#39;blocked-permission&#39;</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-6">return</span><span class="hl-2"> {</span><br/><span class="hl-2">            </span><span class="hl-4">name:</span><span class="hl-2"> </span><span class="hl-4">queryObject</span><span class="hl-2">.</span><span class="hl-4">name</span><span class="hl-2">,</span><br/><span class="hl-2">            </span><span class="hl-4">state:</span><span class="hl-2"> </span><span class="hl-7">&#39;denied&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">            </span><span class="hl-4">status:</span><span class="hl-2"> </span><span class="hl-7">&#39;denied&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">        };</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-6">await</span><span class="hl-2"> </span><span class="hl-4">nativeImpl</span><span class="hl-2">.</span><span class="hl-3">call</span><span class="hl-2">(</span><span class="hl-1">this</span><span class="hl-2">, </span><span class="hl-4">queryObject</span><span class="hl-2">);</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="_-3" class="tsd-anchor-link"><code>ContentFeature.shimInterface(interfaceName, ImplClass, options)</code><a href="#_-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>API for shimming standard constructors. See the WebCompat feature and JSDoc for more details.</p>
<p><strong>Example usage:</strong></p>
<pre><code class="javascript"><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">shimInterface</span><span class="hl-2">(</span><span class="hl-7">&#39;MediaSession&#39;</span><span class="hl-2">, </span><span class="hl-4">MyMediaSessionClass</span><span class="hl-2">, {</span><br/><span class="hl-2">    </span><span class="hl-4">disallowConstructor:</span><span class="hl-2"> </span><span class="hl-1">true</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-4">allowConstructorCall:</span><span class="hl-2"> </span><span class="hl-1">false</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-4">wrapToString:</span><span class="hl-2"> </span><span class="hl-1">true</span><span class="hl-2">,</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="_-4" class="tsd-anchor-link"><code>ContentFeature.shimProperty(instanceHost, instanceProp, implInstance, readOnly = false)</code><a href="#_-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>API for shimming standard global objects. Usually you want to call <code>shimInterface()</code> first, and pass an object instance as <code>implInstance</code>. See the WebCompat feature and JSDoc for more details.</p>
<p><strong>Example usage:</strong></p>
<pre><code class="javascript"><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">shimProperty</span><span class="hl-2">(</span><span class="hl-8">Navigator</span><span class="hl-2">.</span><span class="hl-4">prototype</span><span class="hl-2">, </span><span class="hl-7">&#39;mediaSession&#39;</span><span class="hl-2">, </span><span class="hl-4">myMediaSessionInstance</span><span class="hl-2">, </span><span class="hl-1">true</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="ddg-utilities" class="tsd-anchor-link">DDG Utilities<a href="#ddg-utilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="_-5" class="tsd-anchor-link"><code>DDGProxy</code><a href="#_-5" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Behaves a lot like <code>new window.Proxy</code> with a few differences:</p>
<ul>
<li>Has an <code>overload</code> method to actually apply the function to the native property</li>
<li>Stores the native original property in <code>_native</code> such that it can be called elsewhere if needed without going through the proxy</li>
<li>Triggers <code>addDebugFlag</code> if get/apply is called</li>
<li>Sends debugging messaging if debug is enabled</li>
<li>Allows for remotely disabling the override based on script URL via <code>shouldExemptMethod</code></li>
<li>Fixes <code>value.toString()</code> to appear like it was defined natively</li>
</ul>
<p><strong>Example usage:</strong></p>
<pre><code class="javascript"><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">historyMethodProxy</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DDGProxy</span><span class="hl-2">(</span><span class="hl-1">this</span><span class="hl-2">, </span><span class="hl-8">History</span><span class="hl-2">.</span><span class="hl-4">prototype</span><span class="hl-2">, </span><span class="hl-7">&#39;pushState&#39;</span><span class="hl-2">, {</span><br/><span class="hl-2">    </span><span class="hl-3">apply</span><span class="hl-2">(</span><span class="hl-4">target</span><span class="hl-2">, </span><span class="hl-4">thisArg</span><span class="hl-2">, </span><span class="hl-4">args</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-3">applyRules</span><span class="hl-2">(</span><span class="hl-4">activeRules</span><span class="hl-2">);</span><br/><span class="hl-2">        </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-4">DDGReflect</span><span class="hl-2">.</span><span class="hl-3">apply</span><span class="hl-2">(</span><span class="hl-4">target</span><span class="hl-2">, </span><span class="hl-4">thisArg</span><span class="hl-2">, </span><span class="hl-4">args</span><span class="hl-2">);</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">});</span><br/><span class="hl-4">historyMethodProxy</span><span class="hl-2">.</span><span class="hl-3">overload</span><span class="hl-2">();</span>
</code><button type="button">Copy</button></pre>

<h3 id="_-6" class="tsd-anchor-link"><code>DDGReflect</code><a href="#_-6" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Calls into <code>wrappedJSObject.Reflect</code> for Firefox but otherwise exactly the same as <code>window.Reflect</code></p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#development-utilities"><span>Development <wbr/>Utilities</span></a><ul><li><a href="#overview"><span>Overview</span></a></li><li><a href="#development-setup"><span>Development <wbr/>Setup</span></a></li><li><ul><li><a href="#repository-access"><span>Repository <wbr/>Access</span></a></li><li><a href="#local-development-setup"><span>Local <wbr/>Development <wbr/>Setup</span></a></li><li><a href="#initial-setup"><span>Initial <wbr/>Setup</span></a></li><li><a href="#windows-development"><span>Windows <wbr/>Development</span></a></li><li><a href="#docker-alternative"><span>Docker <wbr/>Alternative</span></a></li></ul></li><li><a href="#contentfeature-utilities"><span>Content<wbr/>Feature <wbr/>Utilities</span></a></li><li><ul><li><a href="#_"><span></span></a></li><li><a href="#_-1"><span></span></a></li><li><a href="#_-2"><span></span></a></li><li><a href="#_-3"><span></span></a></li><li><a href="#_-4"><span></span></a></li></ul></li><li><a href="#ddg-utilities"><span>DDG <wbr/>Utilities</span></a></li><li><ul><li><a href="#_-5"><span></span></a></li><li><a href="#_-6"><span></span></a></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../index.html">@duckduckgo/content-scope-scripts</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
