<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>injected/docs/coding-guidelines | @duckduckgo/content-scope-scripts</title><meta name="description" content="Documentation for @duckduckgo/content-scope-scripts"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">@duckduckgo/content-scope-scripts</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="" aria-current="page">injected/docs/coding-guidelines</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="coding-guidelines" class="tsd-anchor-link">Coding Guidelines<a href="#coding-guidelines" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1>
<blockquote>
<p>Guidelines for injected features development.</p>
</blockquote>
<h2 id="feature-pattern" class="tsd-anchor-link">Feature Pattern<a href="#feature-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Features extend <code>ContentFeature</code> (which itself extends <code>ConfigFeature</code>). Use <code>ContentFeature</code> for features that need messaging, logging, and DOM interaction. Implement lifecycle methods:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> </span><span class="hl-4">ContentFeature</span><span class="hl-2"> </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;../content-feature.js&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-6">export</span><span class="hl-2"> </span><span class="hl-6">default</span><span class="hl-2"> </span><span class="hl-1">class</span><span class="hl-2"> </span><span class="hl-8">MyFeature</span><span class="hl-2"> </span><span class="hl-1">extends</span><span class="hl-2"> </span><span class="hl-8">ContentFeature</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">init</span><span class="hl-2">() {</span><br/><span class="hl-2">        </span><span class="hl-0">// Main initialization - feature is enabled for this site</span><br/><span class="hl-2">        </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSettingEnabled</span><span class="hl-2">(</span><span class="hl-7">&#39;someSetting&#39;</span><span class="hl-2">)) {</span><br/><span class="hl-2">            </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">applySomeFix</span><span class="hl-2">();</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">    }</span><br/><br/><span class="hl-2">    </span><span class="hl-3">load</span><span class="hl-2">() {</span><br/><span class="hl-2">        </span><span class="hl-0">// Early load - before remote config (use sparingly)</span><br/><span class="hl-2">    }</span><br/><br/><span class="hl-2">    </span><span class="hl-3">update</span><span class="hl-2">(</span><span class="hl-4">data</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-0">// Receive updates from browser</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="remote-configuration" class="tsd-anchor-link">Remote Configuration<a href="#remote-configuration" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Use <code>getFeatureSetting()</code> and <code>getFeatureSettingEnabled()</code> to read config:</p>
<pre><code class="js"><span class="hl-0">// Boolean check with default</span><br/><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSettingEnabled</span><span class="hl-2">(</span><span class="hl-7">&#39;settingName&#39;</span><span class="hl-2">)) { ... }</span><br/><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSettingEnabled</span><span class="hl-2">(</span><span class="hl-7">&#39;settingName&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;disabled&#39;</span><span class="hl-2">)) { ... }  </span><span class="hl-0">// default disabled</span><br/><br/><span class="hl-0">// Get setting value (returns typed object from privacy-configuration schema)</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">settings</span><span class="hl-2"> = </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSetting</span><span class="hl-2">(</span><span class="hl-7">&#39;settingName&#39;</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<p><strong>Feature state values:</strong> <code>&quot;enabled&quot;</code> or <code>&quot;disabled&quot;</code>. Features default to disabled unless explicitly enabled.</p>
<p>Types are generated from <code>@duckduckgo/privacy-configuration/schema/features/&lt;name&gt;.json</code>.</p>
<h3 id="conditional-changes" class="tsd-anchor-link">Conditional Changes<a href="#conditional-changes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use <code>conditionalChanges</code> to apply JSON Patch operations based on runtime conditions. Conditions are evaluated in <code>src/config-feature.js</code> (see <code>ConditionBlock</code> typedef and <code>_matchConditionalBlock</code>).</p>
<p><strong>Supported conditions:</strong></p>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>domain</code></td>
<td>Match hostname</td>
<td><code>&quot;domain&quot;: &quot;example.com&quot;</code></td>
</tr>
<tr>
<td><code>urlPattern</code></td>
<td>Match URL (URLPattern API)</td>
<td><code>&quot;urlPattern&quot;: &quot;https://*.example.com/*&quot;</code></td>
</tr>
<tr>
<td><code>experiment</code></td>
<td>Match A/B test cohort</td>
<td><code>&quot;experiment&quot;: { &quot;experimentName&quot;: &quot;test&quot;, &quot;cohort&quot;: &quot;treatment&quot; }</code></td>
</tr>
<tr>
<td><code>context</code></td>
<td>Match frame type</td>
<td><code>&quot;context&quot;: { &quot;frame&quot;: true }</code> or <code>&quot;context&quot;: { &quot;top&quot;: true }</code></td>
</tr>
<tr>
<td><code>minSupportedVersion</code></td>
<td>Minimum platform version</td>
<td><code>&quot;minSupportedVersion&quot;: { &quot;ios&quot;: &quot;17.0&quot; }</code></td>
</tr>
<tr>
<td><code>maxSupportedVersion</code></td>
<td>Maximum platform version</td>
<td><code>&quot;maxSupportedVersion&quot;: { &quot;ios&quot;: &quot;18.0&quot; }</code></td>
</tr>
<tr>
<td><code>injectName</code></td>
<td>Match inject context</td>
<td><code>&quot;injectName&quot;: &quot;apple-isolated&quot;</code></td>
</tr>
<tr>
<td><code>internal</code></td>
<td>Internal builds only</td>
<td><code>&quot;internal&quot;: true</code></td>
</tr>
<tr>
<td><code>preview</code></td>
<td>Preview builds only</td>
<td><code>&quot;preview&quot;: true</code></td>
</tr>
</tbody>
</table>
<p><strong>Config example:</strong></p>
<pre><code class="json"><span class="hl-2">{</span><br/><span class="hl-2">    </span><span class="hl-10">&quot;settings&quot;</span><span class="hl-2">: {</span><br/><span class="hl-2">        </span><span class="hl-10">&quot;conditionalChanges&quot;</span><span class="hl-2">: [</span><br/><span class="hl-2">            {</span><br/><span class="hl-2">                </span><span class="hl-10">&quot;condition&quot;</span><span class="hl-2">: { </span><span class="hl-10">&quot;domain&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;example.com&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">                </span><span class="hl-10">&quot;patchSettings&quot;</span><span class="hl-2">: [{ </span><span class="hl-10">&quot;op&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;replace&quot;</span><span class="hl-2">, </span><span class="hl-10">&quot;path&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;/someSetting&quot;</span><span class="hl-2">, </span><span class="hl-10">&quot;value&quot;</span><span class="hl-2">: </span><span class="hl-1">true</span><span class="hl-2"> }]</span><br/><span class="hl-2">            },</span><br/><span class="hl-2">            {</span><br/><span class="hl-2">                </span><span class="hl-10">&quot;condition&quot;</span><span class="hl-2">: [{ </span><span class="hl-10">&quot;urlPattern&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;https://site1.com/*&quot;</span><span class="hl-2"> }, { </span><span class="hl-10">&quot;urlPattern&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;https://site2.com/path/*&quot;</span><span class="hl-2"> }],</span><br/><span class="hl-2">                </span><span class="hl-10">&quot;patchSettings&quot;</span><span class="hl-2">: [{ </span><span class="hl-10">&quot;op&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;add&quot;</span><span class="hl-2">, </span><span class="hl-10">&quot;path&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;/newSetting&quot;</span><span class="hl-2">, </span><span class="hl-10">&quot;value&quot;</span><span class="hl-2">: </span><span class="hl-7">&quot;enabled&quot;</span><span class="hl-2"> }]</span><br/><span class="hl-2">            }</span><br/><span class="hl-2">        ]</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Key rules:</strong></p>
<ul>
<li>All conditions in a block must match (AND logic)</li>
<li>Array of condition blocks uses OR logic (any block matching applies the patch)</li>
<li><code>patchSettings</code> uses <a href="https://datatracker.ietf.org/doc/html/rfc6902">RFC 6902 JSON Patch</a> with <a href="https://datatracker.ietf.org/doc/html/rfc6901">RFC 6901 JSON Pointer</a> paths (<code>/setting/nested</code>)</li>
<li>Unsupported conditions cause the block to fail (for backwards compatibility)</li>
</ul>
<p>For A/B testing, see <a href="https://github.com/duckduckgo/privacy-configuration/blob/main/.cursor/rules/content-scope-experiments.mdc">privacy-configuration experiments guide</a>.</p>
<h2 id="messaging" class="tsd-anchor-link">Messaging<a href="#messaging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Use inherited messaging methods:</p>
<pre><code class="js"><span class="hl-0">// Fire-and-forget</span><br/><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">notify</span><span class="hl-2">(</span><span class="hl-7">&#39;messageName&#39;</span><span class="hl-2">, { </span><span class="hl-4">data</span><span class="hl-2"> });</span><br/><br/><span class="hl-0">// Request/response</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">response</span><span class="hl-2"> = </span><span class="hl-6">await</span><span class="hl-2"> </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">request</span><span class="hl-2">(</span><span class="hl-7">&#39;messageName&#39;</span><span class="hl-2">, { </span><span class="hl-4">data</span><span class="hl-2"> });</span><br/><br/><span class="hl-0">// Subscribe to updates</span><br/><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">subscribe</span><span class="hl-2">(</span><span class="hl-7">&#39;eventName&#39;</span><span class="hl-2">, (</span><span class="hl-4">data</span><span class="hl-2">) </span><span class="hl-1">=&gt;</span><span class="hl-2"> { ... });</span>
</code><button type="button">Copy</button></pre>

<h2 id="api-shims-error-types" class="tsd-anchor-link">API Shims &amp; Error Types<a href="#api-shims-error-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>When shimming browser APIs, use the correct error types to match native behavior:</p>
<pre><code class="js"><span class="hl-0">// TypeError for invalid arguments</span><br/><span class="hl-6">throw</span><span class="hl-2"> </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">TypeError</span><span class="hl-2">(</span><span class="hl-7">&quot;Failed to execute &#39;lock&#39; on &#39;ScreenOrientation&#39;: 1 argument required&quot;</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// DOMException with name for API-specific errors</span><br/><span class="hl-6">throw</span><span class="hl-2"> </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DOMException</span><span class="hl-2">(</span><span class="hl-7">&#39;Share already in progress&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;InvalidStateError&#39;</span><span class="hl-2">);</span><br/><span class="hl-6">throw</span><span class="hl-2"> </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DOMException</span><span class="hl-2">(</span><span class="hl-7">&#39;Permission denied&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;NotAllowedError&#39;</span><span class="hl-2">);</span><br/><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-8">Promise</span><span class="hl-2">.</span><span class="hl-3">reject</span><span class="hl-2">(</span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DOMException</span><span class="hl-2">(</span><span class="hl-7">&#39;No device selected.&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;NotFoundError&#39;</span><span class="hl-2">));</span>
</code><button type="button">Copy</button></pre>

<p>Common DOMException names: <code>InvalidStateError</code>, <code>NotAllowedError</code>, <code>NotFoundError</code>, <code>AbortError</code>, <code>DataError</code>, <code>SecurityError</code>.</p>
<h2 id="code-style" class="tsd-anchor-link">Code Style<a href="#code-style" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="constants" class="tsd-anchor-link">Constants<a href="#constants" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Avoid constants in the code and prefer using <code>this.getFeatureSetting('constantName') ?? defaultValue</code> to allow for remote configuration to modify the value.</p>
<p>When using <code>getFeatureSettingEnabled()</code>, use its built-in default parameter rather than <code>|| true</code>:</p>
<pre><code class="js"><span class="hl-0">// ✅ Correct - uses second parameter for default</span><br/><span class="hl-12">includeIframes</span><span class="hl-2">: </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSettingEnabled</span><span class="hl-2">(</span><span class="hl-7">&#39;includeIframes&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;enabled&#39;</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// ❌ Wrong - || true ignores explicit false from config</span><br/><span class="hl-12">includeIframes</span><span class="hl-2">: </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">getFeatureSettingEnabled</span><span class="hl-2">(</span><span class="hl-7">&#39;includeIframes&#39;</span><span class="hl-2">) || </span><span class="hl-1">true</span><span class="hl-2">;</span>
</code><button type="button">Copy</button></pre>

<h3 id="event-listener-management" class="tsd-anchor-link">Event Listener Management<a href="#event-listener-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use stored references or the class-based <code>handleEvent</code> pattern to ensure proper removal:</p>
<h4 id="stored-reference-pattern" class="tsd-anchor-link">Stored reference pattern:<a href="#stored-reference-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4>
<pre><code class="js"><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">scrollListener</span><span class="hl-2"> = () </span><span class="hl-1">=&gt;</span><span class="hl-2"> {...};</span><br/><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">addEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;scroll&#39;</span><span class="hl-2">, </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-4">scrollListener</span><span class="hl-2">);</span><br/><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">removeEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;scroll&#39;</span><span class="hl-2">, </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-4">scrollListener</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h4 id="class-based-handleevent-pattern" class="tsd-anchor-link">Class-based handleEvent pattern:<a href="#class-based-handleevent-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4>
<pre><code class="js"><span class="hl-1">class</span><span class="hl-2"> </span><span class="hl-8">MyFeature</span><span class="hl-2"> </span><span class="hl-1">extends</span><span class="hl-2"> </span><span class="hl-8">ContentFeature</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">init</span><span class="hl-2">() {</span><br/><span class="hl-2">        </span><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">addEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;scroll&#39;</span><span class="hl-2">, </span><span class="hl-1">this</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><span class="hl-3">destroy</span><span class="hl-2">() {</span><br/><span class="hl-2">        </span><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">removeEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;scroll&#39;</span><span class="hl-2">, </span><span class="hl-1">this</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><span class="hl-3">handleEvent</span><span class="hl-2">(</span><span class="hl-4">e</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">e</span><span class="hl-2">.</span><span class="hl-4">type</span><span class="hl-2"> === </span><span class="hl-7">&#39;scroll&#39;</span><span class="hl-2">) {</span><br/><span class="hl-2">            </span><span class="hl-3">requestAnimationFrame</span><span class="hl-2">(() </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">updatePosition</span><span class="hl-2">());</span><br/><span class="hl-2">        }</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p><strong>Avoid</strong> using <code>.bind(this)</code> directly in addEventListener—it creates a new reference each time, preventing removal.</p>
<h3 id="module-structure" class="tsd-anchor-link">Module Structure<a href="#module-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Extract reusable logic into separate files for focused unit testing</li>
<li>Security-sensitive operations (e.g., markdown to HTML conversion) should be isolated with extensive tests</li>
</ul>
<h3 id="error-handling-and-debugging" class="tsd-anchor-link">Error Handling and Debugging<a href="#error-handling-and-debugging" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Avoid hardcoding debug flags; ensure they are configurable and environment-dependent</li>
<li>Remove <code>console.log</code> statements from production code and prefer <code>this.log.info</code> instead as this will be disabled in release.</li>
</ul>
<h2 id="architecture-design" class="tsd-anchor-link">Architecture &amp; Design<a href="#architecture-design" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="action-execution-flow" class="tsd-anchor-link">Action Execution Flow<a href="#action-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Execute secondary actions from the top level to avoid context handling issues</li>
<li>Avoid re-calling execution functions within an action</li>
</ul>
<h3 id="navigation-event-handling" class="tsd-anchor-link">Navigation Event Handling<a href="#navigation-event-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Use <code>navigatesuccess</code> event for URL change detection (ensures navigation is committed):</li>
</ul>
<pre><code class="js"><span class="hl-4">globalThis</span><span class="hl-2">.</span><span class="hl-4">navigation</span><span class="hl-2">.</span><span class="hl-3">addEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;navigatesuccess&#39;</span><span class="hl-2">, </span><span class="hl-4">handleURLChange</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="url-change-lifecycle" class="tsd-anchor-link">URL Change Lifecycle<a href="#url-change-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Enable URL tracking for features that need to respond to SPA navigation:</p>
<pre><code class="js"><span class="hl-6">export</span><span class="hl-2"> </span><span class="hl-6">default</span><span class="hl-2"> </span><span class="hl-1">class</span><span class="hl-2"> </span><span class="hl-8">MyFeature</span><span class="hl-2"> </span><span class="hl-1">extends</span><span class="hl-2"> </span><span class="hl-8">ContentFeature</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-4">listenForUrlChanges</span><span class="hl-2"> = </span><span class="hl-1">true</span><span class="hl-2">; </span><span class="hl-0">// Enable URL change tracking</span><br/><br/><span class="hl-2">    </span><span class="hl-3">init</span><span class="hl-2">() {</span><br/><span class="hl-2">        </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">applyFeature</span><span class="hl-2">();</span><br/><span class="hl-2">    }</span><br/><br/><span class="hl-2">    </span><span class="hl-3">urlChanged</span><span class="hl-2">(</span><span class="hl-4">navigationType</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-0">// Called automatically on URL changes</span><br/><span class="hl-2">        </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">recomputeSiteObject</span><span class="hl-2">(); </span><span class="hl-0">// Update config for new path</span><br/><span class="hl-2">        </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">applyFeature</span><span class="hl-2">();</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>Navigation types: <code>'push'</code>, <code>'replace'</code>, <code>'traverse'</code>, <code>'reload'</code>.</p>
<h3 id="re-entrancy-pattern" class="tsd-anchor-link">Re-entrancy Pattern<a href="#re-entrancy-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Check <code>document.readyState</code> to avoid missing DOM elements:</li>
</ul>
<pre><code class="js"><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-4">readyState</span><span class="hl-2"> === </span><span class="hl-7">&#39;loading&#39;</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">addEventListener</span><span class="hl-2">(</span><span class="hl-7">&#39;DOMContentLoaded&#39;</span><span class="hl-2">, () </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">applyFix</span><span class="hl-2">());</span><br/><span class="hl-2">} </span><span class="hl-6">else</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-3">applyFix</span><span class="hl-2">();</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="ddgproxy-pattern" class="tsd-anchor-link">DDGProxy Pattern<a href="#ddgproxy-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use <code>DDGProxy</code> for wrapping browser APIs safely. It automatically adds debug flags, checks exemptions, and preserves <code>toString()</code> behavior:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> { </span><span class="hl-4">DDGProxy</span><span class="hl-2">, </span><span class="hl-4">DDGReflect</span><span class="hl-2"> } </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;../utils&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Wrap a method</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">proxy</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DDGProxy</span><span class="hl-2">(</span><span class="hl-1">this</span><span class="hl-2">, </span><span class="hl-8">Navigator</span><span class="hl-2">.</span><span class="hl-4">prototype</span><span class="hl-2">, </span><span class="hl-7">&#39;getBattery&#39;</span><span class="hl-2">, {</span><br/><span class="hl-2">    </span><span class="hl-3">apply</span><span class="hl-2">(</span><span class="hl-4">target</span><span class="hl-2">, </span><span class="hl-4">thisArg</span><span class="hl-2">, </span><span class="hl-4">args</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-8">Promise</span><span class="hl-2">.</span><span class="hl-3">reject</span><span class="hl-2">(</span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DOMException</span><span class="hl-2">(</span><span class="hl-7">&#39;Not allowed&#39;</span><span class="hl-2">, </span><span class="hl-7">&#39;NotAllowedError&#39;</span><span class="hl-2">));</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">});</span><br/><span class="hl-4">proxy</span><span class="hl-2">.</span><span class="hl-3">overload</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Wrap a property getter</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">propProxy</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">DDGProxy</span><span class="hl-2">(</span><span class="hl-1">this</span><span class="hl-2">, </span><span class="hl-8">Screen</span><span class="hl-2">.</span><span class="hl-4">prototype</span><span class="hl-2">, </span><span class="hl-7">&#39;width&#39;</span><span class="hl-2">, {</span><br/><span class="hl-2">    </span><span class="hl-3">get</span><span class="hl-2">(</span><span class="hl-4">target</span><span class="hl-2">, </span><span class="hl-4">prop</span><span class="hl-2">, </span><span class="hl-4">receiver</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-11">1920</span><span class="hl-2">;</span><br/><span class="hl-2">    },</span><br/><span class="hl-2">});</span><br/><span class="hl-4">propProxy</span><span class="hl-2">.</span><span class="hl-3">overloadProperty</span><span class="hl-2">();</span>
</code><button type="button">Copy</button></pre>

<h3 id="retry-utilities" class="tsd-anchor-link">Retry Utilities<a href="#retry-utilities" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use built-in retry utilities for operations that may need multiple attempts:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> { </span><span class="hl-4">retry</span><span class="hl-2">, </span><span class="hl-4">withRetry</span><span class="hl-2"> } </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;../timer-utils&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Simple retry with config (returns { result, exceptions } for debugging)</span><br/><span class="hl-1">const</span><span class="hl-2"> { </span><span class="hl-5">result</span><span class="hl-2">, </span><span class="hl-5">exceptions</span><span class="hl-2"> } = </span><span class="hl-6">await</span><span class="hl-2"> </span><span class="hl-3">retry</span><span class="hl-2">(() </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-3">findElement</span><span class="hl-2">(</span><span class="hl-4">selector</span><span class="hl-2">), { </span><span class="hl-4">interval:</span><span class="hl-2"> { </span><span class="hl-4">ms:</span><span class="hl-2"> </span><span class="hl-11">1000</span><span class="hl-2"> }, </span><span class="hl-4">maxAttempts:</span><span class="hl-2"> </span><span class="hl-11">30</span><span class="hl-2"> });</span><br/><br/><span class="hl-0">// Retry with automatic error handling</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">element</span><span class="hl-2"> = </span><span class="hl-6">await</span><span class="hl-2"> </span><span class="hl-3">withRetry</span><span class="hl-2">(</span><br/><span class="hl-2">    () </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-4">document</span><span class="hl-2">.</span><span class="hl-3">querySelector</span><span class="hl-2">(</span><span class="hl-4">selector</span><span class="hl-2">),</span><br/><span class="hl-2">    </span><span class="hl-11">4</span><span class="hl-2">, </span><span class="hl-0">// maxAttempts</span><br/><span class="hl-2">    </span><span class="hl-11">500</span><span class="hl-2">, </span><span class="hl-0">// delay ms</span><br/><span class="hl-2">    </span><span class="hl-7">&#39;exponential&#39;</span><span class="hl-2">, </span><span class="hl-0">// strategy: &#39;linear&#39; | &#39;exponential&#39;</span><br/><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="security-privacy" class="tsd-anchor-link">Security &amp; Privacy<a href="#security-privacy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="element-validation" class="tsd-anchor-link">Element Validation<a href="#element-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Validate elements and their types before operations:</li>
</ul>
<pre><code class="js"><span class="hl-6">if</span><span class="hl-2"> (!</span><span class="hl-4">element</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">return</span><span class="hl-2">; </span><span class="hl-0">// or throw appropriate error</span><br/><span class="hl-2">}</span><br/><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">element</span><span class="hl-2"> </span><span class="hl-1">instanceof</span><span class="hl-2"> </span><span class="hl-8">HTMLInputElement</span><span class="hl-2"> || </span><span class="hl-4">element</span><span class="hl-2"> </span><span class="hl-1">instanceof</span><span class="hl-2"> </span><span class="hl-8">HTMLTextAreaElement</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-4">element</span><span class="hl-2">.</span><span class="hl-4">value</span><span class="hl-2"> = </span><span class="hl-4">value</span><span class="hl-2">;</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="caching-and-state-management" class="tsd-anchor-link">Caching and State Management<a href="#caching-and-state-management" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Avoid global or static caching mechanisms that could lead to race conditions</li>
<li>Use instance-scoped storage or include all relevant identifiers in cache keys</li>
</ul>
<h3 id="permissions-handling" class="tsd-anchor-link">Permissions Handling<a href="#permissions-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Ensure custom permission handling does not bypass native permission models</li>
<li>Handle permissions with custom behaviors or name overrides correctly</li>
</ul>
<h3 id="api-usage-in-iframes" class="tsd-anchor-link">API Usage in Iframes<a href="#api-usage-in-iframes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Be cautious enabling APIs like Web Share within iframes, understand that you're exposing message overhead and potential side effects to a third party.</li>
</ul>
<h3 id="captured-globals-pattern" class="tsd-anchor-link">Captured Globals Pattern<a href="#captured-globals-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use captured globals to avoid page-tampered native APIs:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> </span><span class="hl-1">*</span><span class="hl-2"> </span><span class="hl-6">as</span><span class="hl-2"> </span><span class="hl-4">capturedGlobals</span><span class="hl-2"> </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;../captured-globals.js&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Use captured versions instead of global</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">myMap</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-4">capturedGlobals</span><span class="hl-2">.</span><span class="hl-3">Map</span><span class="hl-2">();</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">mySet</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-4">capturedGlobals</span><span class="hl-2">.</span><span class="hl-3">Set</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Dispatch events safely</span><br/><span class="hl-4">capturedGlobals</span><span class="hl-2">.</span><span class="hl-3">dispatchEvent</span><span class="hl-2">(</span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-4">capturedGlobals</span><span class="hl-2">.</span><span class="hl-3">CustomEvent</span><span class="hl-2">(</span><span class="hl-7">&#39;name&#39;</span><span class="hl-2">, { </span><span class="hl-4">detail</span><span class="hl-2"> }));</span>
</code><button type="button">Copy</button></pre>

<h3 id="frame-and-context-guards" class="tsd-anchor-link">Frame and Context Guards<a href="#frame-and-context-guards" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Validate execution context at feature initialization:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> { </span><span class="hl-4">isBeingFramed</span><span class="hl-2"> } </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;../utils&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-3">init</span><span class="hl-2">(</span><span class="hl-4">args</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-3">isBeingFramed</span><span class="hl-2">()) </span><span class="hl-6">return</span><span class="hl-2">;      </span><span class="hl-0">// Skip if in a frame</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (!</span><span class="hl-4">isSecureContext</span><span class="hl-2">) </span><span class="hl-6">return</span><span class="hl-2">;      </span><span class="hl-0">// Skip if not HTTPS</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (!</span><span class="hl-4">args</span><span class="hl-2">.</span><span class="hl-4">messageSecret</span><span class="hl-2">) </span><span class="hl-6">return</span><span class="hl-2">;   </span><span class="hl-0">// Skip if missing required args</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="message-secret-pattern" class="tsd-anchor-link">Message Secret Pattern<a href="#message-secret-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>For cross-world communication, use message secrets to prevent spoofing:</p>
<pre><code class="js"><span class="hl-1">function</span><span class="hl-2"> </span><span class="hl-3">appendToken</span><span class="hl-2">(</span><span class="hl-4">eventName</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-7">`</span><span class="hl-1">${</span><span class="hl-4">eventName</span><span class="hl-1">}</span><span class="hl-7">-</span><span class="hl-1">${</span><span class="hl-4">args</span><span class="hl-9">.</span><span class="hl-4">messageSecret</span><span class="hl-1">}</span><span class="hl-7">`</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Listen with token</span><br/><span class="hl-4">captured</span><span class="hl-2">.</span><span class="hl-3">addEventListener</span><span class="hl-2">(</span><span class="hl-3">appendToken</span><span class="hl-2">(</span><span class="hl-7">&#39;MessageType&#39;</span><span class="hl-2">), </span><span class="hl-4">handler</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Dispatch with token</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">event</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-4">captured</span><span class="hl-2">.</span><span class="hl-3">CustomEvent</span><span class="hl-2">(</span><span class="hl-3">appendToken</span><span class="hl-2">(</span><span class="hl-7">&#39;Response&#39;</span><span class="hl-2">), { </span><span class="hl-4">detail:</span><span class="hl-2"> </span><span class="hl-4">payload</span><span class="hl-2"> });</span><br/><span class="hl-4">captured</span><span class="hl-2">.</span><span class="hl-3">dispatchEvent</span><span class="hl-2">(</span><span class="hl-4">event</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h2 id="performance" class="tsd-anchor-link">Performance<a href="#performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="memory-management-with-weakcollections" class="tsd-anchor-link">Memory Management with WeakCollections<a href="#memory-management-with-weakcollections" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use <code>WeakSet</code>/<code>WeakMap</code> for DOM element references to allow garbage collection:</p>
<pre><code class="js"><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">elementCache</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">WeakMap</span><span class="hl-2">();</span><br/><br/><span class="hl-1">function</span><span class="hl-2"> </span><span class="hl-3">getOrCompute</span><span class="hl-2">(</span><span class="hl-4">element</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">elementCache</span><span class="hl-2">.</span><span class="hl-3">has</span><span class="hl-2">(</span><span class="hl-4">element</span><span class="hl-2">)) {</span><br/><span class="hl-2">        </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-4">elementCache</span><span class="hl-2">.</span><span class="hl-3">get</span><span class="hl-2">(</span><span class="hl-4">element</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    </span><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">result</span><span class="hl-2"> = </span><span class="hl-3">expensiveComputation</span><span class="hl-2">(</span><span class="hl-4">element</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-4">elementCache</span><span class="hl-2">.</span><span class="hl-3">set</span><span class="hl-2">(</span><span class="hl-4">element</span><span class="hl-2">, </span><span class="hl-4">result</span><span class="hl-2">);</span><br/><span class="hl-2">    </span><span class="hl-6">return</span><span class="hl-2"> </span><span class="hl-4">result</span><span class="hl-2">;</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// Delete entries from regular collections after use</span><br/><span class="hl-4">navigations</span><span class="hl-2">.</span><span class="hl-3">delete</span><span class="hl-2">(</span><span class="hl-4">event</span><span class="hl-2">.</span><span class="hl-4">target</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="timed-execution-strategy" class="tsd-anchor-link">Timed Execution Strategy<a href="#timed-execution-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>For dynamic content, use multiple passes at staggered intervals:</p>
<pre><code class="js"><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">hideTimeouts</span><span class="hl-2"> = [</span><span class="hl-11">0</span><span class="hl-2">, </span><span class="hl-11">100</span><span class="hl-2">, </span><span class="hl-11">300</span><span class="hl-2">, </span><span class="hl-11">500</span><span class="hl-2">, </span><span class="hl-11">1000</span><span class="hl-2">, </span><span class="hl-11">2000</span><span class="hl-2">, </span><span class="hl-11">3000</span><span class="hl-2">];</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">unhideTimeouts</span><span class="hl-2"> = [</span><span class="hl-11">1250</span><span class="hl-2">, </span><span class="hl-11">2250</span><span class="hl-2">, </span><span class="hl-11">3000</span><span class="hl-2">];</span><br/><br/><span class="hl-4">hideTimeouts</span><span class="hl-2">.</span><span class="hl-3">forEach</span><span class="hl-2">((</span><span class="hl-4">timeout</span><span class="hl-2">) </span><span class="hl-1">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-3">setTimeout</span><span class="hl-2">(() </span><span class="hl-1">=&gt;</span><span class="hl-2"> </span><span class="hl-3">hideAdNodes</span><span class="hl-2">(</span><span class="hl-4">rules</span><span class="hl-2">), </span><span class="hl-4">timeout</span><span class="hl-2">);</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-0">// Clear caches after all operations complete</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">clearCacheTimer</span><span class="hl-2"> = </span><span class="hl-4">Math</span><span class="hl-2">.</span><span class="hl-3">max</span><span class="hl-2">(...</span><span class="hl-4">hideTimeouts</span><span class="hl-2">, ...</span><span class="hl-4">unhideTimeouts</span><span class="hl-2">) + </span><span class="hl-11">100</span><span class="hl-2">;</span><br/><span class="hl-3">setTimeout</span><span class="hl-2">(() </span><span class="hl-1">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-4">appliedRules</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">Set</span><span class="hl-2">();</span><br/><span class="hl-2">    </span><span class="hl-4">hiddenElements</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">WeakMap</span><span class="hl-2">();</span><br/><span class="hl-2">}, </span><span class="hl-4">clearCacheTimer</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<p>Note: Timers are a useful heuristic to save resources but should be remotely configurable and often other techniques such as carefully engineered MutationObservers would be preferred.</p>
<h3 id="batch-dom-operations" class="tsd-anchor-link">Batch DOM Operations<a href="#batch-dom-operations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use semaphores to batch frequent DOM updates:</p>
<pre><code class="js"><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-4">updatePending</span><span class="hl-2"> = </span><span class="hl-1">false</span><span class="hl-2">;</span><br/><br/><span class="hl-1">function</span><span class="hl-2"> </span><span class="hl-3">scheduleUpdate</span><span class="hl-2">() {</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (!</span><span class="hl-4">updatePending</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-4">updatePending</span><span class="hl-2"> = </span><span class="hl-1">true</span><span class="hl-2">;</span><br/><span class="hl-2">        </span><span class="hl-3">setTimeout</span><span class="hl-2">(() </span><span class="hl-1">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">            </span><span class="hl-3">performDOMUpdate</span><span class="hl-2">();</span><br/><span class="hl-2">            </span><span class="hl-4">updatePending</span><span class="hl-2"> = </span><span class="hl-1">false</span><span class="hl-2">;</span><br/><span class="hl-2">        }, </span><span class="hl-11">10</span><span class="hl-2">);</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="message-bridge-caching" class="tsd-anchor-link">Message Bridge Caching<a href="#message-bridge-caching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Avoid global or static caches for message bridges</li>
<li>Include all relevant parameters (<code>featureName</code>, <code>messageSecret</code>) in cache keys</li>
</ul>
<h2 id="error-handling" class="tsd-anchor-link">Error Handling<a href="#error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<h3 id="asyncawait-usage" class="tsd-anchor-link">Async/Await Usage<a href="#asyncawait-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Use <code>await</code> to ensure errors are caught and flow is maintained:</li>
</ul>
<pre><code class="js"><span class="hl-6">await</span><span class="hl-2"> </span><span class="hl-3">someAsyncFunction</span><span class="hl-2">();</span>
</code><button type="button">Copy</button></pre>

<h3 id="error-handling-in-promises" class="tsd-anchor-link">Error Handling in Promises<a href="#error-handling-in-promises" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Ensure promises have both resolve and reject paths:</li>
</ul>
<pre><code class="js"><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-8">Promise</span><span class="hl-2">((</span><span class="hl-4">resolve</span><span class="hl-2">, </span><span class="hl-4">reject</span><span class="hl-2">) </span><span class="hl-1">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">condition</span><span class="hl-2">) {</span><br/><span class="hl-2">        </span><span class="hl-3">resolve</span><span class="hl-2">(</span><span class="hl-4">result</span><span class="hl-2">);</span><br/><span class="hl-2">    } </span><span class="hl-6">else</span><span class="hl-2"> {</span><br/><span class="hl-2">        </span><span class="hl-3">reject</span><span class="hl-2">(</span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">Error</span><span class="hl-2">(</span><span class="hl-7">&#39;specific error message&#39;</span><span class="hl-2">));</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">});</span>
</code><button type="button">Copy</button></pre>

<h3 id="null-checks" class="tsd-anchor-link">Null Checks<a href="#null-checks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<ul>
<li>Perform null checks before using objects:</li>
</ul>
<pre><code class="js"><span class="hl-6">if</span><span class="hl-2"> (</span><span class="hl-4">object</span><span class="hl-2"> != </span><span class="hl-1">null</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">// Use the object</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h3 id="structured-error-responses" class="tsd-anchor-link">Structured Error Responses<a href="#structured-error-responses" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Use typed error classes for action-based features:</p>
<pre><code class="js"><span class="hl-6">import</span><span class="hl-2"> { </span><span class="hl-4">ErrorResponse</span><span class="hl-2"> } </span><span class="hl-6">from</span><span class="hl-2"> </span><span class="hl-7">&#39;./broker-protection/types.js&#39;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-5">response</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-3">ErrorResponse</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-4">actionID:</span><span class="hl-2"> </span><span class="hl-4">action</span><span class="hl-2">.</span><span class="hl-4">id</span><span class="hl-2">,</span><br/><span class="hl-2">    </span><span class="hl-4">message:</span><span class="hl-2"> </span><span class="hl-7">&#39;Descriptive error message&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">});</span><br/><span class="hl-1">this</span><span class="hl-2">.</span><span class="hl-4">messaging</span><span class="hl-2">.</span><span class="hl-3">notify</span><span class="hl-2">(</span><span class="hl-7">&#39;actionError&#39;</span><span class="hl-2">, { </span><span class="hl-4">error:</span><span class="hl-2"> </span><span class="hl-4">response</span><span class="hl-2"> });</span>
</code><button type="button">Copy</button></pre>

<h3 id="silent-feature-initialization-failures" class="tsd-anchor-link">Silent Feature Initialization Failures<a href="#silent-feature-initialization-failures" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Catch errors without breaking other features:</p>
<pre><code class="js"><span class="hl-6">try</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-4">customElements</span><span class="hl-2">.</span><span class="hl-3">define</span><span class="hl-2">(</span><span class="hl-7">&#39;ddg-element&#39;</span><span class="hl-2">, </span><span class="hl-4">DDGElement</span><span class="hl-2">);</span><br/><span class="hl-2">} </span><span class="hl-6">catch</span><span class="hl-2"> (</span><span class="hl-4">e</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">// May fail on extension reload or conflicts</span><br/><span class="hl-2">    </span><span class="hl-4">console</span><span class="hl-2">.</span><span class="hl-3">error</span><span class="hl-2">(</span><span class="hl-7">&#39;Custom element definition failed:&#39;</span><span class="hl-2">, </span><span class="hl-4">e</span><span class="hl-2">);</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="testing" class="tsd-anchor-link">Testing<a href="#testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>See <a href="injected_docs_testing-guide.html">Testing Guide</a> for comprehensive testing documentation.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#coding-guidelines"><span>Coding <wbr/>Guidelines</span></a><ul><li><a href="#feature-pattern"><span>Feature <wbr/>Pattern</span></a></li><li><a href="#remote-configuration"><span>Remote <wbr/>Configuration</span></a></li><li><ul><li><a href="#conditional-changes"><span>Conditional <wbr/>Changes</span></a></li></ul></li><li><a href="#messaging"><span>Messaging</span></a></li><li><a href="#api-shims-error-types"><span>API <wbr/>Shims &amp; <wbr/>Error <wbr/>Types</span></a></li><li><a href="#code-style"><span>Code <wbr/>Style</span></a></li><li><ul><li><a href="#constants"><span>Constants</span></a></li><li><a href="#event-listener-management"><span>Event <wbr/>Listener <wbr/>Management</span></a></li><li><ul><li><a href="#stored-reference-pattern"><span>Stored reference pattern:</span></a></li><li><a href="#class-based-handleevent-pattern"><span>Class-<wbr/>based handle<wbr/>Event pattern:</span></a></li></ul></li><li><a href="#module-structure"><span>Module <wbr/>Structure</span></a></li><li><a href="#error-handling-and-debugging"><span>Error <wbr/>Handling and <wbr/>Debugging</span></a></li></ul></li><li><a href="#architecture-design"><span>Architecture &amp; <wbr/>Design</span></a></li><li><ul><li><a href="#action-execution-flow"><span>Action <wbr/>Execution <wbr/>Flow</span></a></li><li><a href="#navigation-event-handling"><span>Navigation <wbr/>Event <wbr/>Handling</span></a></li><li><a href="#url-change-lifecycle"><span>URL <wbr/>Change <wbr/>Lifecycle</span></a></li><li><a href="#re-entrancy-pattern"><span>Re-<wbr/>entrancy <wbr/>Pattern</span></a></li><li><a href="#ddgproxy-pattern"><span>DDG<wbr/>Proxy <wbr/>Pattern</span></a></li><li><a href="#retry-utilities"><span>Retry <wbr/>Utilities</span></a></li></ul></li><li><a href="#security-privacy"><span>Security &amp; <wbr/>Privacy</span></a></li><li><ul><li><a href="#element-validation"><span>Element <wbr/>Validation</span></a></li><li><a href="#caching-and-state-management"><span>Caching and <wbr/>State <wbr/>Management</span></a></li><li><a href="#permissions-handling"><span>Permissions <wbr/>Handling</span></a></li><li><a href="#api-usage-in-iframes"><span>API <wbr/>Usage in <wbr/>Iframes</span></a></li><li><a href="#captured-globals-pattern"><span>Captured <wbr/>Globals <wbr/>Pattern</span></a></li><li><a href="#frame-and-context-guards"><span>Frame and <wbr/>Context <wbr/>Guards</span></a></li><li><a href="#message-secret-pattern"><span>Message <wbr/>Secret <wbr/>Pattern</span></a></li></ul></li><li><a href="#performance"><span>Performance</span></a></li><li><ul><li><a href="#memory-management-with-weakcollections"><span>Memory <wbr/>Management with <wbr/>Weak<wbr/>Collections</span></a></li><li><a href="#timed-execution-strategy"><span>Timed <wbr/>Execution <wbr/>Strategy</span></a></li><li><a href="#batch-dom-operations"><span>Batch <wbr/>DOM <wbr/>Operations</span></a></li><li><a href="#message-bridge-caching"><span>Message <wbr/>Bridge <wbr/>Caching</span></a></li></ul></li><li><a href="#error-handling"><span>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#asyncawait-usage"><span>Async/<wbr/>Await <wbr/>Usage</span></a></li><li><a href="#error-handling-in-promises"><span>Error <wbr/>Handling in <wbr/>Promises</span></a></li><li><a href="#null-checks"><span>Null <wbr/>Checks</span></a></li><li><a href="#structured-error-responses"><span>Structured <wbr/>Error <wbr/>Responses</span></a></li><li><a href="#silent-feature-initialization-failures"><span>Silent <wbr/>Feature <wbr/>Initialization <wbr/>Failures</span></a></li></ul></li><li><a href="#testing"><span>Testing</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../index.html">@duckduckgo/content-scope-scripts</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
