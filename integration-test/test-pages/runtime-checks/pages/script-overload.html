<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Runtime checks</title>
  <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[Runtime checks]</a></p>

    <p>This page verifies that script overloading works <a href="../config/script-overload.json">config</a></p>

    <script>
        test('Script should have overloaded properties', async () => {
            // @ts-expect-error https://app.asana.com/0/1201614831475344/1203979574128023/f
            window.scriptOutput = false;
            window.scriptyRan = false;
            const scriptElement = document.createElement('script');
            scriptElement.innerText = `
                window.scriptyRan = true;
                window.scriptOutput = {
                    n: navigator.userAgent,
                    w: window.navigator.userAgent,
                    g: globalThis.navigator.userAgent,
                }
            `;
            scriptElement.id = 'overloadedScript';
            scriptElement.setAttribute('type', 'application/javascript');
            document.body.appendChild(scriptElement);
            const hadInspectorNode = scriptElement === document.querySelector('ddg-runtime-checks');
            const instanceofResult = scriptElement instanceof HTMLScriptElement;
            const scripty = document.querySelector('script#overloadedScript');
            const nodeAndFakeNodeMatch = scripty === scriptElement;
            const expectedUserAgentOverload = 'testingThisOut';
            // We shouldn't break out of the context we're overloading
            const doesntMatchParentContext = navigator.userAgent !== 'testingThisOut';
            return [
                { name: 'hadInspectorNode', result: hadInspectorNode, expected: true },
                { name: 'instanceof matches HTMLScriptElement', result: instanceofResult, expected: true },
                { name: 'script ran', result: window.scriptyRan, expected: true },
                { name: 'node and fake node match', result: nodeAndFakeNodeMatch, expected: false },
                { name: 'user agent is overloaded', result: window.scriptOutput, expected: { n: expectedUserAgentOverload, w: expectedUserAgentOverload, g: expectedUserAgentOverload } },
                { name: 'user agent doesnt match parent context', result: doesntMatchParentContext, expected: true }
            ];
        });

        test('Window methods still work as expected', async () => {
            // @ts-expect-error https://app.asana.com/0/1201614831475344/1203979574128023/f
            window.scriptOutput = false;
            window.scriptyRan = false;
            const scriptElement = document.createElement('script');
            scriptElement.innerText = `
                window.scriptyRan = true;
                window.scriptOutput = window.btoa('testing');
            `;
            scriptElement.id = 'overloadedMethodScript';
            scriptElement.setAttribute('type', 'application/javascript');
            document.body.appendChild(scriptElement);
            const hadInspectorNode = scriptElement === document.querySelector('ddg-runtime-checks#overloadedMethodScript');
            const instanceofResult = scriptElement instanceof HTMLScriptElement;
            const scripty = document.querySelector('script#overloadedScript');
            const nodeAndFakeNodeMatch = scripty === scriptElement;
            return [
                //{ name: 'hadInspectorNode', result: hadInspectorNode, expected: true },
                { name: 'instanceof matches HTMLScriptElement', result: instanceofResult, expected: true },
                { name: 'script ran', result: window.scriptyRan, expected: true },
                { name: 'node and fake node match', result: nodeAndFakeNodeMatch, expected: false },
                { name: 'user agent is overloaded', result: window.scriptOutput, expected: 'dGVzdGluZw==' }
            ];
        });

        renderResults();
    </script>
</body>
</html>
