---
description: Guidelines for injected privacy features development
globs: injected/**
---

# Injected Features

JavaScript features injected into web pages for privacy protections. Features extend `ContentFeature` and `ConfigFeature` and integrate with remote configuration for per-site enable/disable.

**See also:**
- `docs/coding-guidelines.md` for code style and best practices
- [privacy-configuration experiments guide](https://github.com/duckduckgo/privacy-configuration/blob/main/.cursor/rules/content-scope-experiments.mdc) for A/B testing features

## Structure

```
src/features/<name>.js    # Feature implementation (extends ContentFeature)
src/features.js           # Feature registry (baseFeatures + otherFeatures arrays)
entry-points/<platform>.js # Platform-specific bundles
integration-test/         # Playwright integration tests
unit-test/                # Jasmine unit tests
```

**Adding a new feature:** Add to `baseFeatures` or `otherFeatures` in `src/features.js`, then add to relevant platform arrays in `platformSupport`.

## Feature Pattern

Features extend `ContentFeature` (which itself extends `ConfigFeature`). Use `ContentFeature` for features that need messaging, logging, and DOM interaction. Implement lifecycle methods:

```javascript
import ContentFeature from '../content-feature.js';

export default class MyFeature extends ContentFeature {
    init() {
        // Main initialization - feature is enabled for this site
        if (this.getFeatureSettingEnabled('someSetting')) {
            this.applySomeFix();
        }
    }
    
    load() {
        // Early load - before remote config (use sparingly)
    }
    
    update(data) {
        // Receive updates from browser
    }
    
    destroy() {
        // Cleanup: remove event listeners, observers, etc.
        this.sideEffects.destroy();
    }
}
```

### SideEffects Helper

Use `SideEffects` from `src/features/duckplayer/util.js` to track and cleanup side effects:

```javascript
import { SideEffects } from './duckplayer/util.js';

class MyFeature extends ContentFeature {
    sideEffects = new SideEffects();
    
    init() {
        // Wrap side effects with descriptive names for debugging
        this.sideEffects.add('observing DOM mutations', () => {
            const observer = new MutationObserver(this.handleMutation);
            observer.observe(document.body, { childList: true });
            return () => observer.disconnect(); // Return cleanup function
        });
    }
    
    destroy() {
        this.sideEffects.destroy(); // Calls all cleanup functions
        // Or destroy specific effect: this.sideEffects.destroy('observing DOM mutations');
    }
}
```

## Remote Configuration

Use `getFeatureSetting()` and `getFeatureSettingEnabled()` to read config:

```javascript
// Boolean check with default
if (this.getFeatureSettingEnabled('settingName')) { ... }
if (this.getFeatureSettingEnabled('settingName', 'disabled')) { ... }  // default disabled

// Get setting value (returns typed object from privacy-configuration schema)
const settings = this.getFeatureSetting('settingName');
```

Config structure example (from privacy-configuration):
```json
{
  "features": {
    "webCompat": {
      "state": "enabled",
      "settings": {
        "permissions": { "supportedPermissions": { "geolocation": { "native": true } } },
        "viewportWidth": { "forcedDesktopValue": "width=1280" }
      }
    }
  }
}
```

**Feature state values:** `"enabled"` or `"disabled"`. Features default to disabled unless explicitly enabled.

Types are generated from `@duckduckgo/privacy-configuration/schema/features/<name>.json`.

### Conditional Changes

Use `conditionalChanges` to apply JSON Patch operations based on runtime conditions. Conditions are evaluated in [`src/config-feature.js`](src/config-feature.js) (see `ConditionBlock` typedef and `_matchConditionalBlock`).

**Supported conditions:**

| Condition | Description | Example |
|-----------|-------------|---------|
| `domain` | Match hostname | `"domain": "example.com"` |
| `urlPattern` | Match URL (URLPattern API) | `"urlPattern": "https://*.example.com/*"` |
| `experiment` | Match A/B test cohort | `"experiment": { "experimentName": "test", "cohort": "treatment" }` |
| `context` | Match frame type | `"context": { "frame": true }` or `"context": { "top": true }` |
| `minSupportedVersion` | Minimum platform version | `"minSupportedVersion": { "ios": "17.0" }` |
| `maxSupportedVersion` | Maximum platform version | `"maxSupportedVersion": { "ios": "18.0" }` |
| `injectName` | Match inject context | `"injectName": "apple-isolated"` |
| `internal` | Internal builds only | `"internal": true` |
| `preview` | Preview builds only | `"preview": true` |

**Config example:**
```json
{
  "settings": {
    "conditionalChanges": [
      {
        "condition": { "domain": "example.com" },
        "patchSettings": [{ "op": "replace", "path": "/someSetting", "value": true }]
      },
      {
        "condition": [
          { "urlPattern": "https://site1.com/*" },
          { "urlPattern": "https://site2.com/path/*" }
        ],
        "patchSettings": [{ "op": "add", "path": "/newSetting", "value": "enabled" }]
      }
    ]
  }
}
```

**Key rules:**
- All conditions in a block must match (AND logic)
- Array of condition blocks uses OR logic (any block matching applies the patch)
- `patchSettings` uses [RFC 6902 JSON Patch](https://datatracker.ietf.org/doc/html/rfc6902) with [RFC 6901 JSON Pointer](https://datatracker.ietf.org/doc/html/rfc6901) paths (`/setting/nested`)
- Unsupported conditions cause the block to fail (for backwards compatibility)

For A/B testing, see [privacy-configuration experiments guide](https://github.com/duckduckgo/privacy-configuration/blob/main/.cursor/rules/content-scope-experiments.mdc).

## Messaging

Use inherited messaging methods:

```javascript
// Fire-and-forget
this.notify('messageName', { data });

// Request/response
const response = await this.request('messageName', { data });

// Subscribe to updates
this.subscribe('eventName', (data) => { ... });
```

## TypeScript

JSDoc types in JavaScript files. Import types via `@typedef`:

```javascript
/** @typedef {import('../types/feature.js').SettingType} SettingType */
```

## Testing

Run from `injected/` directory:

| Command | Purpose |
|---------|---------|
| `npm run test-unit` | Jasmine unit tests |
| `npm run test-int` | Playwright integration tests |
| `npm run build` | Build all platform bundles |

Integration tests use test pages in `integration-test/test-pages/`.

## Key Patterns

- **Event listeners**: Use `handleEvent` pattern or stored references (avoid `.bind(this)`)
- **API existence**: Check `typeof API === 'function'` before wrapping
- **DOM timing**: Check `document.readyState` before accessing DOM
- **Error types**: Match native error signatures in API shims (see below)

## API Shims & Error Types

When shimming browser APIs, use the correct error types to match native behavior:

```javascript
// TypeError for invalid arguments
throw new TypeError("Failed to execute 'lock' on 'ScreenOrientation': 1 argument required");

// DOMException with name for API-specific errors
throw new DOMException('Share already in progress', 'InvalidStateError');
throw new DOMException('Permission denied', 'NotAllowedError');
return Promise.reject(new DOMException('No device selected.', 'NotFoundError'));
```

Common DOMException names: `InvalidStateError`, `NotAllowedError`, `NotFoundError`, `AbortError`, `DataError`, `SecurityError`.

## Platform Considerations

Features are bundled per-platform in `entry-points/`:
- `apple.js` - iOS/macOS
- `android.js` - Android  
- `windows.js` - Windows
- `extension-mv3.js` - Browser extension

Platform-specific behavior:
```javascript
// Check platform in feature code
if (this.platform.name === 'ios' || this.platform.name === 'android') {
    // Mobile-specific logic
}

// Some features are platform-specific (see utils.js platformSpecificFeatures)
const platformSpecificFeatures = ['navigatorInterface', 'windowsPermissionUsage', 'messageBridge', 'favicon'];
```

## Notes

- When running Playwright commands, use `--reporter list` to prevent hanging
- Features can be enabled/disabled per-site via remote config
- Add debug flags with `this.addDebugFlag()` for breakage reports
