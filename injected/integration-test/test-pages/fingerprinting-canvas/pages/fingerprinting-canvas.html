<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Fingerprinting Canvas</title>
    <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[Fingerprinting Canvas]</a></p>

    <p>This page verifies that canvas fingerprinting output is modified</p>

    <script>
        /**
         * Draw a fingerprint-style pattern on a canvas context
         */
        function drawFingerprintPattern(ctx) {
            ctx.fillStyle = 'rgb(255, 0, 0)';
            ctx.fillRect(0, 0, 50, 50);
            ctx.fillStyle = 'rgb(0, 255, 0)';
            ctx.fillRect(50, 0, 50, 50);
            ctx.fillStyle = 'rgb(0, 0, 255)';
            ctx.fillRect(0, 50, 50, 50);
            ctx.font = '18px Arial';
            ctx.fillStyle = 'rgb(255, 255, 0)';
            ctx.fillText('DuckDuckGo', 10, 30);
        }

        test('Canvas fingerprint protection', async () => {
            const results = [];

            // Create a canvas and draw a fingerprint pattern
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            drawFingerprintPattern(ctx);

            // Get the data URL
            const dataUrl1 = canvas.toDataURL();

            // Get the data URL again - should be consistently modified
            const dataUrl2 = canvas.toDataURL();
            results.push({
                name: 'Repeated toDataURL returns consistent results',
                result: dataUrl1 === dataUrl2,
                expected: true,
            });

            // toDataURL should return a valid data URL
            results.push({
                name: 'toDataURL returns a valid data URL',
                result: dataUrl1.startsWith('data:image/png;base64,'),
                expected: true,
            });

            // getImageData should return modified data
            const imageData = ctx.getImageData(0, 0, 100, 100);
            results.push({
                name: 'getImageData returns data',
                result: imageData.data.length > 0,
                expected: true,
            });

            // Test toBlob returns data
            const blob = await new Promise((resolve) => canvas.toBlob(resolve));
            results.push({
                name: 'toBlob returns a Blob',
                result: blob instanceof Blob,
                expected: true,
            });
            results.push({
                name: 'toBlob Blob has non-zero size',
                result: blob.size > 0,
                expected: true,
            });

            return results;
        });

        test('Canvas data modification evidence', async () => {
            const results = [];

            // Create two canvases with identical patterns and compare their getImageData
            // The protection should add per-session noise, so data is non-trivially present
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            drawFingerprintPattern(ctx);

            const imageData = ctx.getImageData(0, 0, 100, 100);

            // Verify the image data contains non-zero pixels (drawing happened)
            let hasNonZeroPixel = false;
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i] !== 0 || imageData.data[i + 1] !== 0 || imageData.data[i + 2] !== 0) {
                    hasNonZeroPixel = true;
                    break;
                }
            }
            results.push({
                name: 'Canvas has non-zero pixel data after drawing',
                result: hasNonZeroPixel,
                expected: true,
            });

            // Verify alpha channel is fully opaque where we drew (proof drawing worked)
            let hasOpaquePixel = false;
            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] === 255) {
                    hasOpaquePixel = true;
                    break;
                }
            }
            results.push({
                name: 'Canvas has opaque pixels where drawn',
                result: hasOpaquePixel,
                expected: true,
            });

            // Test that getImageData returns consistent results (cached modification)
            const imageData2 = ctx.getImageData(0, 0, 100, 100);
            let isConsistent = true;
            for (let i = 0; i < imageData.data.length; i++) {
                if (imageData.data[i] !== imageData2.data[i]) {
                    isConsistent = false;
                    break;
                }
            }
            results.push({
                name: 'Repeated getImageData returns consistent results',
                result: isConsistent,
                expected: true,
            });

            return results;
        });

        renderResults();
    </script>
</body>
</html>
