<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Conditional Matching</title>
  <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[Infra]</a></p>

    <p>This page verifies that APIs get modified</p>

    <script>
        test('Conditional matching', async () => {
            const results = [
                {
                    name: "APIs changing, expecting to always match",
                    result: navigator.hardwareConcurrency,
                    expected: 222
                }
            ];
            const oldPathname = window.location.pathname;
            const newUrl = new URL(window.location.href);
            newUrl.pathname = "/test/test/path";
            window.history.pushState(null, '', newUrl.href);
            await new Promise(resolve => requestIdleCallback(resolve));
            results.push({
                name: "Expect URL to be changed",
                result: window.location.pathname,
                expected: '/test/test/path'
            })
            results.push({
                name: "APIs changing, expecting to match only when the URL is correct",
                result: navigator.hardwareConcurrency,
                expected: 333
            })
            const popStatePromise = new Promise(resolve => {
                window.addEventListener('popstate', resolve, { once: true });
            });
            // Call pop state to revert the URL
            window.history.back();
            await popStatePromise;
            results.push({
                name: "Expect URL to be reverted",
                result: window.location.pathname,
                expected: oldPathname
            })
            results.push({
                name: "APIs changing, expecting to match only when the URL is correct",
                result: navigator.hardwareConcurrency,
                expected: 222
            })

            return results;
        });

        test('Conditional frame matching', async () => {
            const results = [];
            const frame = document.createElement('iframe');
            const scriptTag = 'script';
            frame.srcdoc = `
                <!DOCTYPE html>
                <html>
                    <body>
                        <${scriptTag}>
                            window.addEventListener('message', (event) => {
                                if (event.data === 'getDeviceMemory') {
                                    event.source.postMessage(navigator.deviceMemory, event.origin);
                                }
                            });
                            // In automation, listen for init args and signal complete
                            document.addEventListener('content-scope-init-args', function (evt) {
                                // Simulate content-scope init logic, then signal complete
                                window.parent.postMessage('content-scope-init-complete', '*');
                            });
                        </${scriptTag}>
                    </body>
                </html>
            `;
            document.body.appendChild(frame);
            await new Promise(resolve => frame.onload = resolve);

            // Send content-scope-init-args to the iframe (use parent's args if available)
            const args = window.__testContentScopeArgs || null;
            // Ensure args isn't blank here
            if (!args) {
                throw new Error('args is blank');
            }
            frame.contentWindow.document.dispatchEvent(
                new CustomEvent('content-scope-init-args', { detail: args })
            );

            // Wait for the iframe to signal it's ready
            await new Promise(resolve => {
                window.addEventListener('message', function handler(event) {
                    if (event.data === 'content-scope-init-complete') {
                        window.removeEventListener('message', handler);
                        resolve();
                    }
                });
            });

            const deviceMemoryPromise = new Promise(resolve => {
                window.addEventListener('message', (event) => {
                    resolve(event.data);
                }, { once: true });
                frame.contentWindow.postMessage('getDeviceMemory', '*');
            });
            const deviceMemory = await deviceMemoryPromise;
            results.push({
                name: "Ensure iframe changes work",
                result: deviceMemory,
                expected: 43338
            });
            results.push({
                name: "Expect frame top modification works",
                result: navigator.deviceMemory,
                expected: 43339
            });
            return results;
        });


        // eslint-disable-next-line no-undef
        renderResults();
    </script>
</body>
</html>
