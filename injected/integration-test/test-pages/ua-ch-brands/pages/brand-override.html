<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>UA CH Brands - Brand Override</title>
  <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[UA CH Brands]</a></p>

    <p>This page verifies that navigator.userAgentData.brands uses the configured brands from the uaChBrands feature settings</p>

    <script>
        test('Brand override', async () => {
            const results = [];

            if (navigator.userAgentData && navigator.userAgentData.brands) {
                const brands = navigator.userAgentData.brands;
                const brandNames = new Set(brands.map(b => b.brand));

                const hasGrease = brands.some(b => {
                    const name = b.brand;
                    return name.trim().startsWith('Not') || /[^\w\s.]/.test(name);
                });

                results.push({
                    name: 'contains Chromium brand',
                    result: brandNames.has('Chromium'),
                    expected: true
                });

                results.push({
                    name: 'contains DuckDuckGo brand',
                    result: brandNames.has('DuckDuckGo'),
                    expected: true
                });

                // Expect 3 brands if GREASE present, 2 if not
                const expectedBrandCount = hasGrease ? 3 : 2;
                results.push({
                    name: `has correct number of brands (${hasGrease ? 'with GREASE' : 'without GREASE'})`,
                    result: brands.length,
                    expected: expectedBrandCount
                });

                if (hasGrease) {
                    results.push({
                        name: 'GREASE value is preserved',
                        result: hasGrease,
                        expected: true
                    });
                }

                results.push({
                    name: 'does not contain Microsoft Edge brand',
                    result: !brandNames.has('Microsoft Edge'),
                    expected: true
                });

                results.push({
                    name: 'does not contain Microsoft Edge WebView2 brand',
                    result: !brandNames.has('Microsoft Edge WebView2'),
                    expected: true
                });

                if (navigator.userAgentData.getHighEntropyValues) {
                    try {
                        const highEntropyValues = await navigator.userAgentData.getHighEntropyValues(['brands']);
                        if (highEntropyValues.brands) {
                            const heBrands = highEntropyValues.brands;
                            const heBrandNames = new Set(heBrands.map(b => b.brand));
                            
                            const heHasGrease = heBrands.some(b => {
                                const name = b.brand;
                                return name.trim().startsWith('Not') || /[^\w\s.]/.test(name);
                            });

                            results.push({
                                name: 'high entropy contains Chromium',
                                result: heBrandNames.has('Chromium'),
                                expected: true
                            });
                            results.push({
                                name: 'high entropy contains DuckDuckGo',
                                result: heBrandNames.has('DuckDuckGo'),
                                expected: true
                            });

                            if (heHasGrease) {
                                results.push({
                                    name: 'high entropy GREASE value is preserved',
                                    result: heHasGrease,
                                    expected: true
                                });
                            }

                            results.push({
                                name: 'high entropy does not contain Microsoft Edge',
                                result: !heBrandNames.has('Microsoft Edge'),
                                expected: true
                            });

                            results.push({
                                name: 'high entropy does not contain Microsoft Edge WebView2',
                                result: !heBrandNames.has('Microsoft Edge WebView2'),
                                expected: true
                            });
                        }
                    } catch (error) {
                        results.push({
                            name: 'getHighEntropyValues works',
                            result: false,
                            expected: true
                        });
                    }
                }
            } else {
                results.push({
                    name: 'navigator.userAgentData.brands available',
                    result: false,
                    expected: true
                });
            }

            return results;
        });

        renderResults();
    </script>
</body>
</html>
