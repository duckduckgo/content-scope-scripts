name: PR Build and Release

on:
    pull_request:
        types: [opened, synchronize, closed, ready_for_review]

permissions: write-all

jobs:
    build:
        if: github.event.action != 'closed'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Use Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: '.nvmrc'
            - uses: actions/cache@v5
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci --verbose

            - name: Run build
              run: npm run build

            - name: Create and push build branch
              id: create_branch
              env:
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

                  # Build branch uses the pr-releases/ prefix to avoid ref conflicts.
                  # A branch named "foo" prevents creating "foo/bar" (and vice-versa)
                  # because git refs are a filesystem hierarchy.  pr-releases/ is a
                  # separate namespace that can never collide with the source branch.
                  BUILD_BRANCH="pr-releases/${PR_HEAD_REF}"

                  git checkout -b "${BUILD_BRANCH}"
                  git add -f build Sources/ContentScopeScripts/dist
                  git commit -m "Build artifacts for ${PR_HEAD_REF} (PR #${PR_NUMBER})"
                  git push -u origin "${BUILD_BRANCH}" --force

                  echo "BRANCH_NAME=${BUILD_BRANCH}" >> $GITHUB_ENV
                  echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_ENV

            - name: Find Previous Comment
              uses: peter-evans/find-comment@v4
              id: find_comment
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-author: 'github-actions[bot]'
                  body-includes: 'Build Branch Update'
                  direction: last

            - name: Create Comment Body
              uses: actions/github-script@v8
              id: create_body
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const branchName = process.env.BRANCH_NAME;
                      const commitHash = process.env.COMMIT_HASH;
                      const prNumber = context.issue.number;
                      const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
                      const branchUrl = `${repoUrl}/tree/${encodeURIComponent(branchName)}`;
                      const commitUrl = `${repoUrl}/commit/${commitHash}`;

                      const lastUpdatedDate = (new Date()).toLocaleString('en-US', {
                          dateStyle: 'long',
                          timeStyle: 'long'
                        });

                      const commentBody = `
                      ### Build Branch Update

                      The build branch has been updated with the latest compiled artifacts.

                        - **Build Branch**: [\`${branchName}\`](${branchUrl})
                        - **Commit Hash**: [\`${commitHash.slice(0, 10)}\`](${commitUrl})
                        - **Last Updated**: ${lastUpdatedDate}

                      #### Integration commands

                      **npm** (Android / Extension):
                      \`\`\`
                      npm i github:duckduckgo/content-scope-scripts#${branchName}
                      \`\`\`

                      **Swift Package Manager** (Apple):
                      \`\`\`swift
                      .package(url: "https://github.com/duckduckgo/content-scope-scripts.git", branch: "${branchName}")
                      \`\`\`

                      **git submodule** (Windows):
                      \`\`\`sh
                      git -C submodules/content-scope-scripts fetch origin ${branchName}
                      git -C submodules/content-scope-scripts checkout origin/${branchName}
                      \`\`\`
                      `;
                      core.setOutput('comment_body', commentBody);
                      core.setOutput('pr_number', prNumber);

            - name: Create, or Update the Comment
              uses: peter-evans/create-or-update-comment@v5
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-id: ${{ steps.find_comment.outputs.comment-id }}
                  body: ${{ steps.create_body.outputs.comment_body }}
                  edit-mode: replace

    clean_up:
        if: github.event.action == 'closed'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Delete build branch
              env:
                  PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git push origin --delete "pr-releases/${PR_HEAD_REF}" || true
